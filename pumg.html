<!DOCTYPE html>
<html>
<head>
<title></title>
</head>
<body>




<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.21.0/phaser.min.js"></script>

<script>

let start = false;
let fire = false;
let websocket;

websocket = new WebSocket("ws://192.168.122.42:2345");
websocket.onmessage = function(obj) {
	let data = JSON.parse(obj.data);

	if (data.player != null)
	{
		console.log(data.player);
		player_num = data.player;
	}
	else if (data.start != null)
	{
		start = true;
	}

	if (data.y != null)
	{
		if (player_num == 1)
			player2_y = data.y;
		else
			player1_y = data.y;
	}

	if (data.bullet_x != null)
	{
		if (player_num == 1)
		{
			bullet2_x = data.bullet_x;
			bullet2_y = data.bullet_y;
		}
		else if (player_num == 2)
		{
			bullet1_x = data.bullet_x;
			bullet1_y = data.bullet_y;
		}
	}
};







let player_num = 0;
let canvas_w = 800;
let canvas_h = 450;
let padding = 128
let player_w = 32;
let player_h = 200;
let player1_x = padding;
let player1_y = canvas_h/2-player_h/2;
let player2_x = canvas_w - padding - player_w;
let player2_y = canvas_h/2-player_h/2;
let bullet1_x = -10;
let bullet1_y = -10;
let bullet2_x = -10;
let bullet2_y = -10;

let graphics;


var config = {
	type: Phaser.AUTO,
	width: canvas_w,
	height: canvas_h,
	backgroundColor: '#2d2d2d',
	parent: 'phaser-example',
	scene: {
		create: create,
		update: update
	}
};

function paintScreen (config) {

	graphics.clear();

	let player1 = new Phaser.Geom.Rectangle(
		player1_x,
		player1_y,
		player_w,
		player_h);

	graphics.fillRectShape(player1);


	let player2 = new Phaser.Geom.Rectangle(
		player2_x,
		player2_y,
		player_w,
		player_h);

	graphics.fillRectShape(player2);

	let bullet1 = new Phaser.Geom.Rectangle(
		bullet1_x,
		bullet1_y,
		10,
		10);

	graphics.fillRectShape(bullet1);

	let bullet2 = new Phaser.Geom.Rectangle(
		bullet2_x,
		bullet2_y,
		10,
		10);

	graphics.fillRectShape(bullet2);

};


function create()
{
	graphics = this.add.graphics({ fillStyle: { color: 0xffffff } });
	
	this.key_up = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
	this.key_down = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
	this.key_space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
	
	paintScreen(this);
};

function update () {

	if(!start)
		return;

	if(fire)
	{
		if (player_num == 1)
			bullet1_x++
		if (player_num == 2)
			bullet2_x--
	}

	if (this.key_up.isDown) 
	{
		console.log('UP');
		if (player_num == 1)
			player1_y -= 4;	
		if (player_num == 2)
			player2_y -= 4;
	}

	if (this.key_down.isDown) 
	{
		console.log('UP');
		if (player_num == 1)
			player1_y += 4;
		if (player_num == 2)
			player2_y += 4;
	}

	if (this.key_space.isDown) 
	{
		if(player_num == 1)
		{
			bullet1_x = player1_x + player_w;
			bullet1_y = player1_y + player_h / 2;
			fire = true;
		}

		if(player_num == 2)
		{
			bullet2_x = player2_x - 10;
			bullet2_y = player2_y + player_h / 2;
			fire = true;
		}	
	}






	
	if(player_num == 1)
	{
		websocket.send('{"y":'+player1_y+'}');
		websocket.send('{"bullet_x":'+bullet1_x+',"bullet_y":'+bullet1_y+'}')
	}
	else if (player_num == 2)
	{
		websocket.send('{"y":'+player2_y+'}');
		websocket.send('{"bullet_x":'+bullet2_x+',"bullet_y":'+bullet2_y+'}')
	}

	paintScreen(this);
};


let game = new Phaser.Game(config);

</script>

</body>
</html>
